rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Allow authenticated users to create, read, update, and delete their own user document.
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;  

      // Allow read and write access to categories subcollection
      match /categories/{categoryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;

        // Allow read and write access to resources subcollection inside categories
        match /resources/{resourceId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }

    // Allow collectionGroup queries on any 'resources' subcollection by checking document.ownerId.
    // This enables queries like collectionGroup('resources').where('ownerId', '==', request.auth.uid)
    // while still enforcing per-document ownership.
    match /{path=**}/resources/{resourceId} {
      allow read: if request.auth != null && resource.data.ownerId == request.auth.uid;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerId;
      allow update, delete: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }

    // Deny all access to any other documents/collections not covered above
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
